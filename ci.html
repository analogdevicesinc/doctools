<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<meta content="Continuous deployment pipeline and instructions to set up a self-hosted GitHub Actions runner using Podman or Docker and systemd without root." name="description" />

    <title>Continuous integration &#8212; Doctools  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=8e8a900e" />
    <link rel="stylesheet" type="text/css" href="_static/app.min.css?v=31a9e0ba" />
    <script async="async" src="_static/app.umd.js?v=3a4867e9"></script>
    <link rel="icon" href="_static/icon.svg"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Sphinx theme" href="theme.html" />
    <link rel="prev" title="Documentation deployment" href="deploy.html" />
   
  
  
  <meta name="repository" content="doctools">
  <meta name="version" content="v0.4.27">
  
    <meta name="page_source_suffix" content=".rst">
  
  
  


<style>
  body {
    
  }

  body.dark {
    
  }

  @media (prefers-color-scheme: dark) {
    body:not(.light) {
      
    }
  }
</style>
  </head>
  
    <body>
  
  <input type="checkbox" id="input-show-toc">
  <input type="checkbox" id="input-show-localtoc">
  <input type="checkbox" id="input-show-repotoc">

  
  <div class="search-area">
    <form action="" method="get">
      <input type="text" name="q" aria-labelledby="search-documentation" value="" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="search" placeholder="Search"/>
      <button class="icon"></button>
    </form>
  </div>
  

  <header>
    <div id="left">
      <label id="show-sidebar" class="icon" for="input-show-toc" title="Show/hide index"></label>
    </div>
    <div id="right">
      <span>
        <a id="logo-org" href="https://analog.com" aria-label="Analog Devices Inc. landing page"></a>
        <div class="vertical-divider"></div>
        
        <label id="show-repotoc" for="input-show-repotoc" title="Show/hide docs" tabindex="0">Docs</label>
        
        <a id="logo" href="index.html">
          <div>Doctools</div>
        </a>
      </span>
      <span class="reverse">
        <label id="show-localtoc" class="icon" for="input-show-localtoc" title="Show/hide contents"></label>
      </span>
    </div>
  </header>


  <div class="repotoc-tree overlay">
    <root>
  <a href="./index.html" class="current">Doctools</a>
</root>

  </div>
    <div class="localtoc">
      <div class="tocwrapper">
        <div class="header localtoc-header">
          <a id="scroll-up" href="#top-anchor" title="Back to top"></a>
        </div>
        <nav>
          <ul>
<li><a class="reference internal" href="#">Continuous integration</a><ul>
<li><a class="reference internal" href="#configure-podman">Configure podman</a><ul>
<li><a class="reference internal" href="#network-users-partitions">Network users &amp; partitions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#build-the-container-image">Build the container image</a></li>
<li><a class="reference internal" href="#interactive-run">Interactive run</a></li>
<li><a class="reference internal" href="#self-hosted-runner">Self-hosted runner</a></li>
<li><a class="reference internal" href="#self-hosted-cluster">Self-hosted cluster</a></li>
</ul>
</li>
</ul>

        </nav>
      </div>
    </div>

  
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
    <a id="no-logo" href="index.html">
      Doctools
    </a><input id="input-switch-toc" type="checkbox">
<label id="show-repotoc" for="input-switch-toc">
All content
</label>
<label id="show-toc" for="input-switch-toc">
Content on this topic
</label>
<div class="repotoc-tree">
  <root>
  <a href="./index.html" class="current">Doctools</a>
</root>

</div>
<div class="toc-tree">
  <html>
  <body><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="fundamentals.html">Fundamentals</a></li>
<li class="toctree-l1"><input class="toctree-collapse" type="checkbox" name="toctree-collapse-1" id="toctree-collapse-1"/><div class="collapse"><a class="reference internal" href="docs_guidelines/index.html">Documentation guidelines</a><label for="toctree-collapse-1"><div class="icon"></div></label></div><ul>
<li class="toctree-l2"><a class="reference internal" href="docs_guidelines/directives.html">Custom directives</a></li>
<li class="toctree-l2"><a class="reference internal" href="docs_guidelines/roles.html">Custom roles</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">Command line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploy.html">Documentation deployment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Continuous integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="theme.html">Sphinx theme</a></li>
</ul>
</body>
</html>

</div>
        </div>
      </div>

  <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper" id="top-anchor">
          <div class="body-header">
  <nav class="breadcrumb empty"><ol></ol></nav>
</div>
          <div class="body" role="main">
            
  <section id="continuous-integration">
<span id="ci"></span><h1>Continuous integration<a class="headerlink" href="#continuous-integration" title="Link to this heading"></a></h1>
<p>Doctools has a continuous deployment integration pipeline that works as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                   ┌──────────────────┐
                ┌─►│Build Doc Latest  ├─┐
                │  └──────────────────┘ │
                │                       │
┌─────────────┐ │  ┌────────────────┐   │  ┌──────────────┐
│Build Package├─┼─►│Build Doc on Min├───┼─►│Deploy Package│
└─────────────┘ │  └────────────────┘   │  └──────────────┘
                │                       │
                │  ┌──────────┐         │
                ├─►│Custom Doc├─────────┤
                │  └──────────┘         │
                │                       │
                │  ┌─────┐              │
                └─►│Tests├──────────────┘
                   └─────┘
</pre></div>
</div>
<p>The Build Package step “compiles” JavaScript and SASS, fetches third-party
assets and licenses and generates the Python package.</p>
<p>Then, in the middle-stage, two parallel runs are launched:</p>
<ul class="simple">
<li><p><em>Build Doc Latest</em>: uses the latest stable dependencies releases to
generate this documentation, and store as an artifact.</p></li>
<li><p><em>Build Doc on Min</em>: uses the minimum requirements dependencies to generate
this documentation, but the output is discarded.</p></li>
<li><p><em>Custom Doc</em>: calls <a class="reference internal" href="cli.html#custom-doc"><span class="std std-ref">Custom Doc</span></a> to check if the CLI tool succeeds in
generating a full custom PDF document.</p></li>
<li><p><em>Tests</em>: run tests using <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, in special, methods that are not called
during the <em>Build Doc *</em> pipelines.</p></li>
</ul>
<p>Both of them are set to fail-on-warning during the documentation generation.</p>
<p>Finally, the Deploy Package:</p>
<ul class="simple">
<li><p>Grabs the version and checks if the tag version already exists:</p>
<ul>
<li><p>If so, set to update the symbolic <code class="docutils literal notranslate"><span class="pre">pre-release</span></code> release.</p></li>
<li><p>If not, set to update the symbolic <code class="docutils literal notranslate"><span class="pre">latest</span></code> and <code class="docutils literal notranslate"><span class="pre">pre-relase</span></code> release.</p></li>
</ul>
</li>
<li><p>Still if a new version:</p>
<ul>
<li><p>Create the git tag and push to origin.</p></li>
<li><p>Create the tagged release.</p></li>
<li><p>Upload the artifact to the tagged release.</p></li>
</ul>
</li>
<li><p>Upload the artifact to the symbolic release (<code class="docutils literal notranslate"><span class="pre">pre-release</span></code>, <code class="docutils literal notranslate"><span class="pre">latest</span></code>).</p></li>
<li><p>Finally, the <em>Build Doc Latest</em> artifact is downloaded and deployed to the
branch <code class="docutils literal notranslate"><span class="pre">gh-pages</span></code></p></li>
</ul>
<p>By design, the live page on <em>github.io</em> follows the pre-release/latest commit-ish;
properly versioned live documentation should be managed by an external system
that watches the git tags (e.g.
<a class="icon link reference external" href="https://github.com/readthedocs/readthedocs.org" target="_blank">readthedocs</a>).</p>
<p>This approach allows having a single defined version on <code class="docutils literal notranslate"><span class="pre">adi_doctools/__init__.py</span></code>,
and have the tags created and releases created/updated without much fuzz.</p>
<p>The philosophy is to have <code class="docutils literal notranslate"><span class="pre">latest</span></code> updated on tag increment and first
successful run, and <code class="docutils literal notranslate"><span class="pre">pre-relese</span></code> updated on successful run without tag change.
These releases exist to provide a pointer to the latest/pre-release packages, e.g.
<a class="icon link reference external" href="https://github.com/analogdevicesinc/doctools/releases/download/latest/adi-doctools.tar.gz" target="_blank">releases/download/latest/adi-doctools.tar.gz</a>.</p>
<p>Non-handled corner-cases mitigations:</p>
<ul class="simple">
<li><p>Release <code class="docutils literal notranslate"><span class="pre">pre-release</span></code> and <code class="docutils literal notranslate"><span class="pre">latest</span></code> must exist prior the first run.</p></li>
<li><p>Branch <code class="docutils literal notranslate"><span class="pre">gh-pages</span></code> must exist with at least one commit.</p></li>
</ul>
<section id="configure-podman">
<span id="conf-podman"></span><h2>Configure podman<a class="headerlink" href="#configure-podman" title="Link to this heading"></a></h2>
<p>Below are suggested instructions for setting up <code class="docutils literal notranslate"><span class="pre">podman</span></code> on a Linux environment,
if you wish to use it as your container engine. If you already use something else
like <code class="docutils literal notranslate"><span class="pre">docker</span></code>, <strong>keep it</strong> and skip this section.</p>
<p>Adjust to your preference as needed, and skip the steps marked in <span class="green">green</span>
if not using WSL2.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">podman</span></code> from your package manager.</p>
<p><span class="green">Ensure cgroup v2 on wsl2’s .wslconfig:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wsl2</span><span class="p">]</span>
<span class="n">kernelCommandLine</span> <span class="o">=</span> <span class="n">cgroup_no_v1</span><span class="o">=</span><span class="nb">all</span> <span class="n">systemd</span><span class="o">.</span><span class="n">unified_cgroup_hierarchy</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p><span class="green">Restart wsl2.</span></p>
<p>Enable podman service for your user.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>--now<span class="w"> </span>--user<span class="w"> </span>podman.socket
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>start<span class="w"> </span>--user<span class="w"> </span>podman.socket
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Set the <code class="docutils literal notranslate"><span class="pre">DOCKER_HOST</span></code> variable on your <em>~/.bashrc</em>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span><span class="w"> </span><span class="nv">DOCKER_HOST</span><span class="o">=</span>unix://<span class="nv">$XDG_RUNTIME_DIR</span>/podman/podman.sock
</pre></div>
</div>
<section id="network-users-partitions">
<span id="podman-sssd"></span><h3>Network users &amp; partitions<a class="headerlink" href="#network-users-partitions" title="Link to this heading"></a></h3>
<p>Podman default configuration expects a local user to be able to create a user
namespace where multiple IDs are mapped and a compatible partition to use as
the storage location <code class="docutils literal notranslate"><span class="pre">graphRoot</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ideal solution is to create a local <strong>non-root</strong> user and storage
location. Podman processes should then be started under this user UID.</p>
</div>
<p>Network systems using solutions such as <a class="icon link reference external" href="https://sssd.io/" target="_blank">SSSD</a> do not
append the user to the system (is not listed in <code class="docutils literal notranslate"><span class="pre">/etc/subuid</span></code>), so automatic
user namespace is not possible. To be compatible with this configuration, a
single UID within a user space needs to be used, achieved with the
<code class="docutils literal notranslate"><span class="pre">ignore_chown_errors</span></code> parameter.</p>
<p>Normally these systems also mount an network file system (nfs) as the home folder,
which is also not supported.
In this case, the <code class="docutils literal notranslate"><span class="pre">graphRoot</span></code> location needs to be set to somewhere else
(an easy test location is <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p>
<p>This is an example of <em>~/.config/containers/storage.conf</em> to support such
environments:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[storage]</span>
<span class="na">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;overlay&quot;</span>
<span class="c1"># Set to a path in a non-nfs partition</span>
<span class="na">graphRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tmp&quot;</span>

<span class="k">[storage.options.overlay]</span>
<span class="c1"># Single UID</span>
<span class="na">ignore_chown_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span>
</pre></div>
</div>
<p>Ensure apply with <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">system</span> <span class="pre">migrate</span></code> and see the changed settings with
<code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">info</span></code>.</p>
<p>An alternative mitigation for nfs is to create a xfs disk image and mount, but
since mount requires a root permission it is unlikely to be helpful for most
users:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>truncate<span class="w"> </span>-s<span class="w"> </span>100g<span class="w"> </span>~/.local/share/containers-xfs.img
mkfs.xfs<span class="w"> </span>-m<span class="w"> </span><span class="nv">reflink</span><span class="o">=</span><span class="m">1</span><span class="w">  </span>~/.local/share/containers-xfs.img<span class="w"> </span>-m<span class="w"> </span><span class="nv">bigtime</span><span class="o">=</span><span class="m">1</span>,inobtcount<span class="o">=</span><span class="m">1</span><span class="w"> </span>-i<span class="w"> </span><span class="nv">nrext64</span><span class="o">=</span><span class="m">0</span>
sudo<span class="w"> </span>mount<span class="w"> </span>~/.local/share/containers-xfs.img<span class="w"> </span>~/.local/share/containers
</pre></div>
</div>
</section>
</section>
<section id="build-the-container-image">
<span id="image-podman"></span><h2>Build the container image<a class="headerlink" href="#build-the-container-image" title="Link to this heading"></a></h2>
<p>To build the container image, use your favorite container engine:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/doctools
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">alias</span><span class="w"> </span><span class="nv">container</span><span class="o">=</span>podman<span class="w"> </span><span class="c1"># or docker, ...</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>container<span class="w"> </span>build<span class="w"> </span>--tag<span class="w"> </span>adi/doctools:v1<span class="w"> </span>ci
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>You may want to build the container in a host, where you have all your tools installed,
and then deploy to a server.
In this case, export the image and then import on the server:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>container<span class="w"> </span>save<span class="w"> </span>-o<span class="w"> </span>adi-doctools.tar<span class="w"> </span>adi/doctools:v1
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>scp<span class="w"> </span>adi-doctools.tar<span class="w"> </span>server:/tmp/
</pre></div>
</div>
<div class="clear-left"></div></div></div><div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>admin@server:/tmp$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>container<span class="w"> </span>load<span class="w"> </span>-i<span class="w"> </span>adi-doctools.tar
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Or if you are feeling adventurous:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>user@host:~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>container<span class="w"> </span>save<span class="w"> </span>adi/doctools:v1<span class="w"> </span><span class="p">|</span><span class="w"> </span>ssh<span class="w"> </span>server<span class="w"> </span><span class="s2">&quot;cat - | podman load&quot;</span>
</pre></div>
</div>
<div class="clear-left"></div></div></div></section>
<section id="interactive-run">
<span id="id1"></span><h2>Interactive run<a class="headerlink" href="#interactive-run" title="Link to this heading"></a></h2>
<p>At its core, the workflows are straight forward, roughly they do:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Tests</span></code> step:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>tests<span class="w"> </span><span class="p">;</span><span class="w"> </span>pytest
</pre></div>
</div>
<div class="clear-left"></div></div></div><p><code class="docutils literal notranslate"><span class="pre">Build</span> <span class="pre">Doc</span> <span class="pre">*</span></code>:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>docs<span class="w"> </span><span class="p">;</span><span class="w"> </span>make<span class="w"> </span>html
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>But at a specific minimum and maximum supported environment version.</p>
<p><code class="docutils literal notranslate"><span class="pre">Custom</span> <span class="pre">Doc</span></code>:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>/tmp/test-pdf<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$_</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>/tmp/test-pdf$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>adoc<span class="w"> </span>custom-doc<span class="w"> </span><span class="p">;</span><span class="w"> </span>adoc<span class="w"> </span>custom-doc
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Doing the relevant step on host covers most issues that the CI would catch.</p>
<p>You can use the <a class="reference internal" href="#image-podman"><span class="std std-ref">container image</span></a> with
<a class="icon git reference external" href="https://github.com/analogdevicesinc/doctools/tree/main/ci/scripts/container-run.sh" target="_blank">this suggested bash method</a>
to interactive login into an image, mounting the provided path, to run the steps
on the container, for example:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cr<span class="w"> </span>adi/doctools:v1<span class="w"> </span>.
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3.13<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>venv
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>venv/bin/activate<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>pip3.13<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>pip3.13<span class="w"> </span>install<span class="w"> </span>pytest
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>tests<span class="w"> </span><span class="p">;</span><span class="w"> </span>pytest
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools/tests$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
</pre></div>
</div>
<div class="clear-left"></div></div></div></section>
<section id="self-hosted-runner">
<span id="podman-run"></span><h2>Self-hosted runner<a class="headerlink" href="#self-hosted-runner" title="Link to this heading"></a></h2>
<p>To host your <a class="icon link reference external" href="https://github.com/actions/runner" target="_blank">GitHub Actions Runner</a>,
set up your secrets:</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># e.g. analogdevicesinc/doctools</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="w"> </span>ORG_REPOSITORY<span class="w"> </span><span class="p">|</span><span class="w"> </span>podman<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>public_doctools_org_repository<span class="w"> </span>-
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># e.g. MyVerYSecRunnerToken</span>
</pre></div>
</div>
<div class="clear-left"></div></div><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">printf</span><span class="w"> </span>RUNNER_TOKEN<span class="w"> </span><span class="p">|</span><span class="w"> </span>podman<span class="w"> </span>secret<span class="w"> </span>create<span class="w"> </span>public_doctools_runner_token<span class="w"> </span>-
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>The runner token is obtained from the GUI at <code class="docutils literal notranslate"><span class="pre">github.com/&lt;org&gt;/&lt;repository&gt;/settings/actions/runners/new</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">github_token</span></code> from <a class="reference internal" href="#cluster-podman"><span class="std std-ref">Self-hosted cluster</span></a> is set, the runner_token
is ignored and a new one is requested.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>podman<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--secret<span class="w"> </span>public_doctools_org_repository,type<span class="o">=</span>env,target<span class="o">=</span>org_repository<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--secret<span class="w"> </span>public_doctools_runner_token,type<span class="o">=</span>env,target<span class="o">=</span>runner_token<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--env<span class="w"> </span><span class="nv">runner_labels</span><span class="o">=</span>repo-only,v1,big_cpu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>adi/doctools:v1
</pre></div>
</div>
<div class="clear-left"></div></div></div><div><div class="collapsible docutils container">
<input class="collapsible_input" id="6c0c02ea33af4cbc332d9bc2650cc6b615efc51c" name="6c0c02ea33af4cbc332d9bc2650cc6b615efc51c" type="checkbox"></input><label for="6c0c02ea33af4cbc332d9bc2650cc6b615efc51c"><p>Docker alternative</p>
<div class="icon"></div></label><div class="collapsible_content docutils container">
<p><code class="docutils literal notranslate"><span class="pre">docker</span></code> does <strong>not</strong> have a built-in keyring, instead you pass directly
to <code class="docutils literal notranslate"><span class="pre">run</span></code> command. <span class="red">Consider hardening strategies to mitigate risks</span>,
like using other keyring software as below.</p>
<div class="code-shell"><div><div class="no-select float-left highlight-default notranslate"><div class="highlight"><pre><span></span>~/doctools$
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>run<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--env<span class="w"> </span><span class="nv">public_doctools_org_repository</span><span class="o">=</span><span class="k">$(</span>gpg<span class="w"> </span>--quiet<span class="w"> </span>--batch<span class="w"> </span>--decrypt<span class="w"> </span>/run/secrets/public_doctools_org_repository.gpg<span class="k">)</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--env<span class="w"> </span><span class="nv">public_doctools_runner_token</span><span class="o">=</span><span class="k">$(</span>gpg<span class="w"> </span>--quiet<span class="w"> </span>--batch<span class="w"> </span>--decrypt<span class="w"> </span>/run/secrets/public_doctools_runner_token.gpg<span class="k">)</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--env<span class="w"> </span><span class="nv">runner_labels</span><span class="o">=</span>repo-only,v1,big_cpu<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>localhost/adi/doctools:v1
</pre></div>
</div>
<div class="clear-left"></div></div></div><p>Or <code class="docutils literal notranslate"><span class="pre">systemd-creds</span></code>. If your system supports, consider protecting with TPM2.</p>
</div>
</div>
</div><p>The environment variable runner_labels (comma-separated), set the runner labels.
If not provided on the Containerfile as <code class="docutils literal notranslate"><span class="pre">ENV</span> <span class="pre">runner_labels=&lt;labels,&gt;</span></code> or as argument
<code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">runner_labels=&lt;labels,&gt;</span></code>, it defaults to <code class="docutils literal notranslate"><span class="pre">v1</span></code>.
Most of the time, you want to use the Containerfile-set environment variable.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">repo-only</span></code> label ensures that the jobs run only in the repository-scoped runners,
avoiding them to assigned to organization-level runners.</p>
<p>If you are in an environment as described in <a class="reference internal" href="#podman-sssd"><span class="std std-ref">Network users &amp; partitions</span></a>, append these flags
to every <code class="docutils literal notranslate"><span class="pre">podman</span> <span class="pre">run</span></code> command:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--user</span> <span class="pre">root</span></code>: due to <code class="docutils literal notranslate"><span class="pre">ignore_chown_errors</span></code> allowing a single user mapping,
this user is root (0). Please note that this the container’s root user and in
most images is the only available user.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--env</span> <span class="pre">RUNNER_ALLOW_RUNASROOT=1</span></code>: suppresses the GitHub Action runner “Must
not run with sudo”. Again, is the container’s root.</p></li>
</ul>
</section>
<section id="self-hosted-cluster">
<span id="cluster-podman"></span><h2>Self-hosted cluster<a class="headerlink" href="#self-hosted-cluster" title="Link to this heading"></a></h2>
<p>To host a cluster of self-hosted runners, the recommended approach is to use
systemd services, instead of for example, container compose solutions.</p>
<p>Below is a suggested systemd service at <em>~/.config/systemd/user/container-public-doctools&#64;.service</em>.</p>
<div class="highlight-systemd notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">container public doctools ci %i</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>

<span class="k">[Service]</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-success</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/podman run </span>\
<span class="w">          </span><span class="s">--env name_label=%H-%i </span>\
<span class="w">          </span><span class="s">--env runner_labels=repo-only,v1 </span>\
<span class="w">          </span><span class="s">--secret public_doctools_org_repository,type=env,target=org_repository </span>\
<span class="w">          </span><span class="s">--secret public_doctools_runner_token,type=env,target=runner_token </span>\
<span class="w">          </span><span class="s">--conmon-pidfile %t/%n-pid --cidfile %t/%n-cid </span>\
<span class="w">          </span><span class="s">--label &quot;io.containers.autoupdate=local&quot; </span>\
<span class="w">          </span><span class="s">--name=public_doctools_%i </span>\
<span class="w">          </span><span class="s">--memory-swap=20g </span>\
<span class="w">          </span><span class="s">--memory=16g </span>\
<span class="w">          </span><span class="s">--cpus=4 </span>\
<span class="w">          </span><span class="s">-d adi/doctools:v1 top</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/sh -c &quot;/bin/podman stop -t 300 $(cat %t/%n-cid) &amp;&amp; /bin/podman rm $(cat %t/%n-cid)&quot;</span>
<span class="na">ExecStopPost</span><span class="o">=</span><span class="s">/bin/rm %t/%n-pid %t/%n-cid</span>
<span class="na">TimeoutStopSec</span><span class="o">=</span><span class="s">600</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>
<span class="na">PIDFile</span><span class="o">=</span><span class="s">%t/%n-pid</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">default.target</span>
</pre></div>
</div>
<div><div class="collapsible docutils container">
<input class="collapsible_input" id="ece968691cbd677c8d43ccfe3eb12f4753745316" name="ece968691cbd677c8d43ccfe3eb12f4753745316" type="checkbox"></input><label for="ece968691cbd677c8d43ccfe3eb12f4753745316"><p>Docker alternative</p>
<div class="icon"></div></label><div class="collapsible_content docutils container">
<div class="highlight-systemd notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">container public doctools ci %i</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">gpg-passphrase.service</span>
<span class="na">Wants</span><span class="o">=</span><span class="s">network-online.target</span>
<span class="na">After</span><span class="o">=</span><span class="s">docker.service</span>

<span class="k">[Service]</span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-success</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/bin/sh -c &quot;/bin/docker run </span>\
<span class="w">          </span><span class="s">--env name_label=%H-%i </span>\
<span class="w">          </span><span class="s">--env runner_labels=repo-only,v1 </span>\
<span class="w">          </span><span class="s">--env org_repository=$(gpg --quiet --batch --decrypt /run/secrets/public_doctools_org_repository.gpg) </span>\
<span class="w">          </span><span class="s">--env runner_token=$(gpg --quiet --batch --decrypt /run/secrets/public_doctools_runner_token.gpg) </span>\
<span class="w">          </span><span class="s">--cidfile %t/%n-cid </span>\
<span class="w">          </span><span class="s">--label &quot;io.containers.autoupdate=local&quot; </span>\
<span class="w">          </span><span class="s">--name=public_doctools_%i </span>\
<span class="w">          </span><span class="s">--memory-swap=20g </span>\
<span class="w">          </span><span class="s">--memory=16g </span>\
<span class="w">          </span><span class="s">--cpus=4 </span>\
<span class="w">          </span><span class="s">--log-driver=journald </span>\
<span class="w">          </span><span class="s">-d localhost/adi/doctools:v1 top&quot;</span>
<span class="na">RemainAfterExit</span><span class="o">=</span><span class="s">yes</span>
<span class="na">ExecStop</span><span class="o">=</span><span class="s">/bin/sh -c &quot;/bin/docker stop -t 300 $(cat %t/%n-cid) &amp;&amp; /bin/docker rm $(cat %t/%n-cid)&quot;</span>
<span class="na">ExecStopPost</span><span class="o">=</span><span class="s">/bin/rm %t/%n-cid</span>
<span class="na">TimeoutStopSec</span><span class="o">=</span><span class="s">600</span>
<span class="na">Type</span><span class="o">=</span><span class="s">forking</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">default.target</span>
</pre></div>
</div>
</div>
</div>
</div><p>Remember to <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">--user</span> <span class="pre">daemon-reload</span></code> after modifying.
With <a class="icon link reference external" href="https://docs.podman.io/en/latest/markdown/podman-auto-update.1.html" target="_blank">autoupdate</a>,
if the image-digest of the container and local storage differ,
the local image is considered to be newer and the systemd unit gets restarted.</p>
<p>Tune the limit flags for your needs.
The <code class="docutils literal notranslate"><span class="pre">--cpus</span></code> flag requires a kernel with <code class="docutils literal notranslate"><span class="pre">CONFIG_CFS_BANDWIDTH</span></code> enabled.
You can check with <code class="docutils literal notranslate"><span class="pre">zgrep</span> <span class="pre">CONFIG_CFS_BANDWIDTH=</span> <span class="pre">/proc/config.gz</span></code>.</p>
<p>Instead of passing <code class="docutils literal notranslate"><span class="pre">runner_token</span></code>, you can also pass a <code class="docutils literal notranslate"><span class="pre">github_token</span></code> to
generate the <code class="docutils literal notranslate"><span class="pre">runner_token</span></code> on demand. Using the <code class="docutils literal notranslate"><span class="pre">github_token</span></code> is the
recommended approach because during clean-up the original runner_token may have
expired already.</p>
<p>Alternatively, you can mount a FIFO to <code class="docutils literal notranslate"><span class="pre">/var/run/secrets/runner_token</span></code> to
generate a token just in time, without ever passing the github_token to the
container (scripts not provided).</p>
<p>However, please note, just like the GitHub Actions generated <code class="docutils literal notranslate"><span class="pre">GITHUB_TOKEN</span></code>,
the path <code class="docutils literal notranslate"><span class="pre">/run/secrets/runner_token</span></code> can be read by workflows, while the
previous option is removed from the environment prior executing the GitHub
Actions runtime.</p>
<p>The order of precedence for authentication token is:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">github_token</span></code>: environment variable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runner_token</span></code>: plain text or FIFO at <em>/run/secrets/runner_token</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">runner_token</span></code>: environment variable.</p></li>
</ol>
<p>Please understand the security implications and ensure the token secrecy,
by for example, require manual approval for running workflows PRs from
third party sources and don’t relax <code class="docutils literal notranslate"><span class="pre">runner</span></code> user permissions.</p>
<p>The required GitHub Fine-Grained token permission should be set as follows:</p>
<p>For <a class="icon link reference external" href="https://docs.github.com/en/rest/actions/self-hosted-runners?apiVersion=2022-11-28#create-a-registration-token-for-a-repository--fine-grained-access-tokens" target="_blank">repository runner</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">administration:write</span></code>: “Administration” repository permissions (write).</p></li>
</ul>
<p>For <a class="icon link reference external" href="https://docs.github.com/en/rest/actions/self-hosted-runners?apiVersion=2022-11-28#create-a-registration-token-for-an-organization" target="_blank">org runner</a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">organization_self_hosted_runners:write</span></code>: “Self-hosted runners” organization permissions (write).</p></li>
<li><p>The user needs to be an org-level admin.</p></li>
</ul>
<p>Then update the systemd service.</p>
<p>Enable and start the service</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>systemctl<span class="w"> </span>--user<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>container-public-doctools@0.service
systemctl<span class="w"> </span>--user<span class="w"> </span>start<span class="w"> </span>container-public-doctools@0.service
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>User services are terminated on logout, unless you define
<code class="docutils literal notranslate"><span class="pre">loginctl</span> <span class="pre">enable-linger</span> <span class="pre">&lt;your-user&gt;</span></code> first.</p>
</div>
</section>
</section>


          </div>
              <div class="related">
                &nbsp;
    <a href="deploy.html" title="Previous document (Alt+Shift+LeftArrow)" class="prev">Documentation deployment</a>
    <a href="theme.html" title="Next document (Alt+Shift+RightArrow)" class="next">Sphinx theme</a>
              </div>
          
        </div>
      </div>
  </div>

  <label id="cancel-area-show-toc" for="input-show-toc"></label>
  <label id="cancel-area-show-localtoc" for="input-show-localtoc"></label>
    <footer>
      &#169;2024, Analog Devices, Inc.
      
      |
      Made with <a href="https://www.sphinx-doc.org/">Sphinx</a>
      &amp; <a href="https://github.com/analogdevicesinc/doctools">Doctools</a>
      
    </footer>
  </body>
</html>